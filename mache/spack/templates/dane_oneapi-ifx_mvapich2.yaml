{%- set compiler = "oneapi@2023.2.1" %}
{%- set mpi = "mvapich2@2.3.7" %}
{%- set mkl = "intel-oneapi-mkl@2022.1.0" %}

spack:
  specs:
  - {{ mpi }}%{{ compiler }}
{%- if e3sm_lapack %}
  - {{ mkl }}%{{ compiler }}
{%- endif %}
{%- if e3sm_hdf5_netcdf %}
  - "hdf5%{{ compiler }}"
  - "netcdf-c%{{ compiler }}"
  - "netcdf-fortran%{{ compiler }}"
  - "parallel-netcdf%{{ compiler }}"
{%- endif %}
{%- for spec in specs %}
  - "{{ spec }}%{{ compiler }}"
{%- endfor %}
  concretizer:
    unify: true
  packages:
    all:
      compiler: [oneapi@2023.2.1, gcc@12.1.1]
      providers:
        mpi: [mvapich2@2.3.7]
{%- if e3sm_lapack %}
        lapack: [intel-oneapi-mkl@2022.1.0]
{%- endif %}
    perl:
      externals:
      - spec: perl@5.26.3+cpanm+opcode+open+shared+threads
        prefix: /usr
      buildable: false
    bzip2:
      externals:
      - spec: bzip2@1.0.6
        prefix: /usr
      buildable: false
    bison:
      externals:
      - spec: bison@3.0.4
        prefix: /usr
      buildable: false
    flex:
      externals:
      - spec: flex@2.6.1+lex
        prefix: /usr
      buildable: false
    findutils:
      externals:
      - spec: findutils@4.6.0
        prefix: /usr
      buildable: false
    automake:
      externals:
      - spec: automake@1.16.1
        prefix: /usr
      buildable: false
    m4:
      externals:
      - spec: m4@1.4.18
        prefix: /usr
      buildable: false
    libtool:
      externals:
      - spec: libtool@2.4.6
        prefix: /usr
      buildable: false
    autoconf:
      externals:
      - spec: autoconf@2.69
        prefix: /usr
      buildable: false
    cmake:
      externals:
      - spec: cmake@3.26.3
        prefix: /usr/tce/packages/cmake/cmake-3.26.3
      buildable: false
    gmake:
      externals:
      - spec: gmake@4.2.1
        prefix: /usr
      buildable: false
    pkgconf:
      externals:
      - spec: pkgconf@1.4.2
        modules:
        - pkgconf/1.4.2
      buildable: false
    mvapich2:
      externals:
      - spec: {{ mpi }}~cuda~debug+regcache+wrapperrpath ch3_rank_bits=32 file_systems=lustre,nfs,ufs
          process_managers=hydra threads=multiple %{{ compiler }}
        prefix: /usr/tce/packages/mvapich2/mvapich2-2.3.7-intel-2023.2.1-magic
        modules:
        - mvapich2/2.3.7
      buildable: false
    gcc:
      externals:
      - spec: gcc@12.1.1 languages='c,c++,fortran'
        prefix: /usr/tce/packages/gcc/gcc-12.1.1-magic
        extra_attributes:
          compilers:
            c: /usr/tce/packages/gcc/gcc-12.1.1-magic/bin/gcc
            cxx: /usr/tce/packages/gcc/gcc-12.1.1-magic/bin/g++
            fortran: /usr/tce/packages/gcc/gcc-12.1.1-magic/bin/gfortran
        modules:
        - gcc/12.1.1-magic
      buildable: false
    oneapi:
      externals:
      - spec: {{ compiler }}
        prefix: /usr/tce/packages/intel/intel-2023.2.1-magic
        extra_attributes:
          compilers:
            c: /usr/tce/packages/intel/intel-2023.2.1-magic/bin/icx
            cxx: /usr/tce/packages/intel/intel-2023.2.1-magic/bin/icpx
            fortran: /usr/tce/packages/intel/intel-2023.2.1-magic/bin/ifx
        modules:
        - intel/2023.2.1-magic
        - intel-oneapi-runtime/2023.2.0
        - gcc-runtime/12.1.1
      buildable: false
    intel-oneapi-runtime:
      externals:
      - spec: intel-oneapi-runtime@2023.2.1
        modules:
        - intel-oneapi-runtime/2023.2.0
    gcc-runtime:
      externals:
      - spec: gcc-runtime@12.1.1
        modules:
        - gcc-runtime/12.1.1
{%- if e3sm_lapack %}
    intel-oneapi-mkl:
      externals:
      - spec: {{ mkl }}
        prefix: /usr/tce/packages/mkl/mkl-2022.1.0
        modules:
        - mkl/2022.1.0
      buildable: false
{%- endif %}
{%- if e3sm_hdf5_netcdf %}
    hdf5:
      externals:
      - spec: hdf5@1.14.5
        prefix: /usr/workspace/e3sm/spack/dane/intel/libs/linux-sapphirerapids/hdf5-1.14.5
        modules:
        - hdf5/1.14.5
      buildable: false
    netcdf-c:
      externals:
      - spec: netcdf-c@4.9.2
        prefix: /usr/workspace/e3sm/spack/dane/intel/libs/linux-sapphirerapids/netcdf-c-4.9.2
        modules:
        - netcdf-c/4.9.2
      buildable: false
    netcdf-fortran:
      externals:
      - spec: netcdf-fortran@4.6.1
        prefix: /usr/workspace/e3sm/spack/dane/intel/libs/linux-sapphirerapids/netcdf-fortran-4.6.1
        modules:
        - netcdf-fortran/4.6.1
      buildable: false
    parallel-netcdf:
      externals:
      - spec: parallel-netcdf@1.14.0 
        prefix: /usr/workspace/e3sm/spack/dane/intel/libs/linux-sapphirerapids/parallel-netcdf-1.14.0
        modules:
        - parallel-netcdf/1.14.0 
      buildable: false
{%- endif %}
  compilers:
  - compiler:
      spec: {{ compiler }}
      paths:
        cc: /usr/tce/packages/intel/intel-2023.2.1-magic/bin/icx
        cxx: /usr/tce/packages/intel/intel-2023.2.1-magic/bin/icpx
        f77: /usr/tce/packages/intel/intel-2023.2.1-magic/bin/ifx
        fc: /usr/tce/packages/intel/intel-2023.2.1-magic/bin/ifx
      flags: {}
      operating_system: rhel8
      target: x86_64
      modules: []
      environment: {}
      extra_rpaths: []

